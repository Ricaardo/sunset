# 天气影响功能说明

## 概述

本服务已集成智能天气检测功能，**完全免费，零配置**，可根据实时天气自动调整火烧云预测等级。

## 核心特性

### ✅ 完全免费
- 使用 [Open-Meteo](https://open-meteo.com/) 开源天气API
- 无需注册账号，无需API密钥
- 无请求限制，完全免费使用

### 🎯 智能判断
系统会自动分析以下天气因素：
- **云量**：云层覆盖百分比（0-100%）
- **降水量**：当前小时降水量（毫米）
- **天气状况**：晴、多云、雨、雪等

### 🔧 自动调整
根据天气影响程度，自动调整火烧云质量等级：

| 天气情况 | 云量/降水 | 影响等级 | 系统处理 |
|---------|----------|---------|---------|
| ☀️ 晴朗 | 云量 < 70% | 无影响 | 不调整，正常预测 |
| ⛅ 多云 | 云量 70-85% | 轻微 | 添加天气提醒 |
| ☁️ 阴天/小雨 | 云量 > 85% 或有降水 | 中等 | **降低1个等级** + 提醒 |
| 🌧️ 大雨 | 降水 > 5mm | 严重 | **降低2个等级** + 强烈提醒 |

## 实际案例

### 案例1：晴朗天气（无影响）
```
天气状况：晴朗
云量：45%
降水量：0mm

结果：
✅ 不调整预测等级
原始预测：大烧 → 最终推送：大烧
```

### 案例2：多云天气（轻微影响）
```
天气状况：多云
云量：75%
降水量：0mm

结果：
⛅ 添加天气提醒，不降级
推送消息中会显示：
"⛅ 天气提醒：当前云量75%，可能会略微影响火烧云的观赏效果。"
```

### 案例3：阴天（中等影响）
```
天气状况：阴
云量：90%
降水量：0mm

结果：
☁️ 降低1个等级 + 天气提醒
原始预测：大烧 → 最终推送：中等烧到大烧
推送消息中会显示：
"☁️ 天气提醒：当前云量较高（90%），可能会遮挡部分火烧云。"
```

### 案例4：小雨（中等影响）
```
天气状况：小雨
云量：85%
降水量：2.5mm

结果：
🌧️ 降低1个等级 + 天气提醒
原始预测：典型大烧 → 最终推送：大烧
推送消息中会显示：
"🌧️ 天气提醒：当前有降水（2.5mm），可能会影响火烧云观测效果。"
```

### 案例5：大雨（严重影响）
```
天气状况：大雨
云量：100%
降水量：8.5mm

结果：
⚠️ 降低2个等级 + 强烈提醒
原始预测：大烧 → 最终推送：小烧到中等烧
推送消息中会显示：
"⚠️ 天气提醒：当前大雨，降水量8.5mm，预计火烧云效果将大幅减弱甚至无法观测。建议改日观赏。"
```

## 工作流程

```
1. 定时任务触发
   ↓
2. 获取火烧云预测数据（sunsetbot.top）
   ↓
3. 判断初始质量等级（如：大烧）
   ↓
4. 调用 Open-Meteo API 获取实时天气
   ↓
5. 分析天气影响（云量、降水）
   ↓
6. 根据影响等级调整质量
   - 无影响：不调整
   - 轻微影响：保持等级，添加提醒
   - 中等影响：降低1级
   - 严重影响：降低2级
   ↓
7. 生成推送消息（包含天气提醒）
   ↓
8. 发送到企业微信
```

## API 技术细节

### Open-Meteo API 请求
```bash
curl "https://api.open-meteo.com/v1/forecast?latitude=31.2304&longitude=121.4737&current=temperature_2m,precipitation,cloud_cover,weather_code&timezone=Asia/Shanghai"
```

### 响应示例
```json
{
  "current": {
    "temperature_2m": 22.5,
    "precipitation": 0.0,
    "cloud_cover": 45,
    "weather_code": 0
  }
}
```

### 天气代码对照表（WMO标准）
| 代码 | 描述 |
|-----|------|
| 0 | 晴朗 ☀️ |
| 1-3 | 多云 ⛅ |
| 45, 48 | 雾 🌫️ |
| 51, 53, 55 | 毛毛雨 🌦️ |
| 61, 63, 65 | 雨 🌧️ |
| 71, 73, 75 | 雪 ❄️ |
| 80-82 | 阵雨 🌦️ |
| 95 | 雷暴 ⛈️ |

## 容错机制

系统具有完善的容错处理：

1. **API失败自动降级**
   - 如果天气API请求失败，系统会记录日志但继续执行
   - 不考虑天气影响，使用原始火烧云预测等级
   - 确保推送服务不受天气API影响

2. **网络超时保护**
   - 天气API请求超时时间：10秒
   - 超时后自动放弃天气检测，继续推送

3. **数据解析错误处理**
   - 如果无法解析天气数据，跳过天气影响分析
   - 日志记录错误信息，便于排查

## 测试方法

### 方法1：使用测试脚本
```bash
./test_weather.sh
```

### 方法2：手动测试
```bash
# 测试上海天气
curl "https://api.open-meteo.com/v1/forecast?latitude=31.2304&longitude=121.4737&current=temperature_2m,precipitation,cloud_cover,weather_code&timezone=Asia/Shanghai"

# 测试北京天气
curl "https://api.open-meteo.com/v1/forecast?latitude=39.9042&longitude=116.4074&current=temperature_2m,precipitation,cloud_cover,weather_code&timezone=Asia/Shanghai"
```

### 方法3：主动触发推送
```bash
# 启动服务
./deploy.sh

# 主动触发一次推送（会应用天气影响）
curl http://localhost:8080/trigger-push
```

## 优势对比

| 特性 | 本方案 (Open-Meteo) | 和风天气 | OpenWeatherMap |
|-----|-------------------|---------|----------------|
| 费用 | **完全免费** | 免费额度有限 | 免费额度有限 |
| API Key | **不需要** | 需要 | 需要 |
| 注册 | **不需要** | 需要 | 需要 |
| 请求限制 | **无限制** | 1000次/天 | 1000次/天 |
| 数据来源 | NOAA, DWD等 | 多源 | 多源 |
| 响应速度 | 快 | 快 | 中等 |
| 文档质量 | 优秀 | 良好 | 优秀 |

## 常见问题

### Q1: 为什么选择 Open-Meteo？
**A:** 因为它：
- 完全免费开源
- 无需注册和API Key
- 无请求限制
- 数据准确（整合多个专业气象源）
- 响应快速且稳定

### Q2: 天气数据多久更新一次？
**A:** Open-Meteo 通常每小时更新一次。我们的服务每天推送1-2次，数据时效性完全满足需求。

### Q3: 如果 Open-Meteo 服务不可用怎么办？
**A:** 系统会自动降级，不考虑天气影响，继续正常推送火烧云预报。核心功能不受影响。

### Q4: 可以切换到其他天气API吗？
**A:** 可以！只需修改 `main.go` 中的 `getWeatherData()` 函数即可。

### Q5: 天气检测支持所有城市吗？
**A:** 是的！只要配置了正确的经纬度，Open-Meteo 支持全球任何位置。

### Q6: 天气影响的阈值可以调整吗？
**A:** 可以！在 `analyzeWeatherImpact()` 函数中修改云量和降水的判断阈值。

## 技术支持

如有问题，可以：
1. 查看日志：`docker compose logs -f sunset`
2. 测试天气API：`./test_weather.sh`
3. 访问 Open-Meteo 官网：https://open-meteo.com/
4. 提交 Issue：https://github.com/你的仓库/issues

---

**提示**：天气影响功能已默认启用，无需任何配置！
